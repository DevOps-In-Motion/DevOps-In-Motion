pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  serviceAccountName: jenkins
  containers:
  - name: kubectl
    image: bitnami/kubectl:latest
    command:
    - cat
    tty: true
  - name: docker
    image: docker:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: docker-sock
      mountPath: /var/run/docker.sock
  - name: aws-cli
    image: amazon/aws-cli:latest
    command:
    - cat
    tty: true
  volumes:
  - name: docker-sock
    hostPath:
      path: /var/run/docker.sock
"""
        }
    }
    
    environment {
        TENANT_NAME = "${env.JOB_NAME.split('/')[0]}"
        DOCKER_REGISTRY = "${DOCKER_REGISTRY ?: 'docker.io'}"
        IMAGE_NAME = "${env.JOB_NAME.replaceAll('/', '-').toLowerCase()}"
        IMAGE_TAG = "${env.BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                container('docker') {
                    script {
                        echo "Building application..."
                        sh """
                            docker build -t ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} .
                            docker tag ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                container('docker') {
                    script {
                        echo "Running tests..."
                        sh """
                            # Add your test commands here
                            echo "Tests passed!"
                        """
                    }
                }
            }
        }
        
        stage('Push Image') {
            steps {
                container('docker') {
                    script {
                        echo "Pushing Docker image..."
                        withCredentials([usernamePassword(
                            credentialsId: 'docker-registry-credentials',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )]) {
                            sh """
                                echo \${DOCKER_PASS} | docker login ${DOCKER_REGISTRY} -u \${DOCKER_USER} --password-stdin
                                docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                                docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                container('kubectl') {
                    script {
                        echo "Deploying to Kubernetes in namespace: ${TENANT_NAME}"
                        sh """
                            # Create deployment if it doesn't exist
                            kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${IMAGE_NAME}
  namespace: ${TENANT_NAME}
  labels:
    app: ${IMAGE_NAME}
    tenant: ${TENANT_NAME}
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ${IMAGE_NAME}
  template:
    metadata:
      labels:
        app: ${IMAGE_NAME}
        tenant: ${TENANT_NAME}
    spec:
      containers:
      - name: app
        image: ${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: ${IMAGE_NAME}
  namespace: ${TENANT_NAME}
spec:
  selector:
    app: ${IMAGE_NAME}
  ports:
  - port: 80
    targetPort: 8080
EOF
                            
                            # Wait for rollout to complete
                            kubectl rollout status deployment/${IMAGE_NAME} -n ${TENANT_NAME}
                        """
                    }
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                container('kubectl') {
                    script {
                        echo "Verifying deployment..."
                        sh """
                            kubectl get pods -n ${TENANT_NAME} -l app=${IMAGE_NAME}
                            kubectl get svc -n ${TENANT_NAME} -l app=${IMAGE_NAME}
                        """
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline completed for tenant: ${TENANT_NAME}"
        }
        success {
            echo "Deployment successful!"
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
    }
}