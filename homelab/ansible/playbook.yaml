# playbook.yml
- name: Setup Kubernetes Cluster
  hosts: k8s_cluster
  become: true
  tasks:
    - name: Install prerequisite packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - software-properties-common
        state: present
        update_cache: yes

    - name: Disable swap
      shell: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swap from fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^.*swap.*$'
        state: absent

    - name: Load kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Set sysctl params
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    - name: Install containerd
      apt:
        name: containerd
        state: present

    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory

    - name: Generate containerd config
      shell: containerd config default > /etc/containerd/config.toml

    - name: Enable SystemdCgroup in containerd
      lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*SystemdCgroup\s*='
        line: '            SystemdCgroup = true'
        backrefs: yes

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Add Kubernetes apt key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key
        state: present

    - name: Add Kubernetes apt repository
      apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /"
        state: present

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet={{ k8s_version }}-*
          - kubeadm={{ k8s_version }}-*
          - kubectl={{ k8s_version }}-*
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

- name: Initialize Control Plane
  hosts: control_plane
  become: true
  tasks:
    - name: Initialize kubeadm
      shell: |
        kubeadm init \
          --pod-network-cidr={{ pod_network_cidr }} \
          --service-cidr={{ service_cidr }} \
          --apiserver-advertise-address={{ ansible_default_ipv4.address }}
      register: kubeadm_init
      args:
        creates: /etc/kubernetes/admin.conf

    - name: Create .kube directory
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to .kube/config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'

    - name: Install Calico CNI
      shell: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Get join command
      shell: kubeadm token create --print-join-command
      register: join_command

    - name: Save join command
      set_fact:
        k8s_join_command: "{{ join_command.stdout }}"

    - name: Create SSH secret for workers
      shell: |
        kubectl create secret generic ssh-credentials \
          --from-file=ssh-privatekey=/root/.ssh/id_rsa \
          --from-file=ssh-publickey=/root/.ssh/id_rsa.pub \
          --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: lookup('fileglob', '/root/.ssh/id_rsa') | length > 0

- name: Join Worker Nodes
  hosts: workers
  become: true
  tasks:
    - name: Join cluster
      shell: "{{ hostvars[groups['control_plane'][0]]['k8s_join_command'] }}"
      args:
        creates: /etc/kubernetes/kubelet.conf

- name: Configure Worker Nodes
  hosts: control_plane
  become: true
  tasks:
    - name: Wait for nodes to be ready
      shell: kubectl get nodes | grep -v NotReady || true
      register: nodes_status
      until: nodes_status.rc == 0
      retries: 30
      delay: 10
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Label worker nodes
      shell: |
        kubectl label node {{ hostvars[item]['inventory_hostname'] }} {{ hostvars[item]['node_label'] }} --overwrite
      loop: "{{ groups['workers'] }}"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Apply taints for pod scheduling (require specific labels)
      shell: |
        kubectl taint node {{ hostvars[item]['inventory_hostname'] }} \
          restricted=true:NoSchedule --overwrite
      loop: "{{ groups['workers'] }}"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Create resource quota namespace
      shell: |
        kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Apply resource requirements configuration
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: LimitRange
        metadata:
          name: resource-limits
          namespace: production
        spec:
          limits:
          - max:
              cpu: "2"
              memory: 4Gi
            min:
              cpu: "100m"
              memory: 128Mi
            default:
              cpu: "500m"
              memory: 512Mi
            defaultRequest:
              cpu: "250m"
              memory: 256Mi
            type: Container
        ---
        apiVersion: v1
        kind: ResourceQuota
        metadata:
          name: compute-quota
          namespace: production
        spec:
          hard:
            requests.cpu: "20"
            requests.memory: 40Gi
            limits.cpu: "40"
            limits.memory: 80Gi
        EOF
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Create SSH secret in production namespace
      shell: |
        kubectl create secret generic ssh-connection-secret \
          --from-literal=ssh-host=jumphost.example.com \
          --from-literal=ssh-user=deploy \
          --from-file=ssh-key=/root/.ssh/id_rsa \
          --namespace=production \
          --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: lookup('fileglob', '/root/.ssh/id_rsa') | length > 0

    - name: Create example deployment with all requirements
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: example-app
          namespace: production
        spec:
          replicas: 3
          selector:
            matchLabels:
              app: example
          template:
            metadata:
              labels:
                app: example
            spec:
              # Toleration to allow scheduling on tainted nodes
              tolerations:
              - key: "restricted"
                operator: "Equal"
                value: "true"
                effect: "NoSchedule"
              # Node selector to target specific labeled nodes
              nodeSelector:
                tier: frontend
              # Resource requirements
              containers:
              - name: app
                image: nginx:latest
                resources:
                  requests:
                    cpu: "250m"
                    memory: "256Mi"
                  limits:
                    cpu: "500m"
                    memory: "512Mi"
                # SSH secret mounted as volume
                volumeMounts:
                - name: ssh-keys
                  mountPath: /etc/ssh-keys
                  readOnly: true
                env:
                - name: SSH_HOST
                  valueFrom:
                    secretKeyRef:
                      name: ssh-connection-secret
                      key: ssh-host
                - name: SSH_USER
                  valueFrom:
                    secretKeyRef:
                      name: ssh-connection-secret
                      key: ssh-user
              volumes:
              - name: ssh-keys
                secret:
                  secretName: ssh-connection-secret
                  defaultMode: 0600
                  items:
                  - key: ssh-key
                    path: id_rsa
        EOF
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

- name: Display Cluster Info
  hosts: control_plane
  become: true
  tasks:
    - name: Get cluster info
      shell: kubectl get nodes -o wide
      register: cluster_nodes
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Display nodes
      debug:
        msg: "{{ cluster_nodes.stdout_lines }}"